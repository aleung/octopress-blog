
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Good good study, day day up</title>
  <meta name="author" content="Leo Liang">

  
  <meta name="description" content="Android是基于Linux的系统，这是对开发者很方便的。今天手机上网不太正常，想到抓些包来看看，于是上网google一下，就找到教程了：Debugging with Tcpdump。我的ROM没有预装tcpdump（据说cm的rom有），自己编译也太麻烦了，网上也可以找到编译好的包，搜索” &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://aleung.github.com/blog/blog/page/12/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/GoodGoodStudyDayDayUp" rel="alternate" title="Good good study, day day up" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2827715-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Good good study, day day up</a></h1>
  
    <h2>aleung的学习笔记, aleung的idea</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/GoodGoodStudyDayDayUp" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:aleung.github.com/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/03/19/Grab-Android-system-on-network-communication/">抓取Android系统上的网络通信</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-03-19T13:33:00+08:00" pubdate data-updated="true">2010-03-19</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/android/'>Android</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>Android是基于Linux的系统，这是对开发者很方便的。今天手机上网不太正常，想到抓些包来看看，于是上网google一下，就找到教程了：<a href="http://pdk.android.com/online-pdk/guide/tcpdump.html">Debugging with Tcpdump</a>。我的ROM没有预装tcpdump（据说cm的rom有），自己编译也太麻烦了，网上也可以找到编译好的包，搜索”tcpdump-arm”可找到。</p>

<p>有了tcpdump，要分析别人的应用干了些什么也方便多了。例如这是 Google Maps 获取network location的包：</p>

<pre><code>POST /loc/m/api HTTP/1.1
Connection: close
Content-Type: application/binary
Content-Length: 496
Host: www.google.com
User-Agent: GMM/3.0 (dream ERE27); gzip

...."location,1.0,android,android,en_US... I.....g...........g:loc/ql......
..
.1.0.Iandroid/google/passion/passion/mahimahi:2.1/ERD72/22132:user/release-keys.#2:l-7Yxu1UHhuUZlb5:F_iqbZnw84bV2J0q*.zh_CN2
....CMCC .(...
.voicesearch..
.com.diddo.diddo.diddo..
.apps.maps..
.com.lim.android.automemman"..
..
...I...... ..(.......$....I...... ..(.....I...... ..(.....I...... ..(.....I...... ..(.....I...... ..(."...I...... ..(.0..K"...I...... ..(.0..J"...I...... ..(.0..."...I...... ..(.0...(......


HTTP/1.1 200 OK
Content-Type: application/binary
Content-Disposition: attachment
Cache-Control: no-cache, no-store, max-age=0, must-revalidate
Pragma: no-cache
Expires: Fri, 01 Jan 1990 00:00:00 GMT
Date: Fri, 19 Mar 2010 04:49:31 GMT
X-Content-Type-Options: nosniff
X-Frame-Options: SAMEORIGIN
Content-Length: 188
Server: GSE
X-XSS-Protection: 0
Connection: close

..............g...)...........`.Z... $...k.......fg./,
.....,.."....cZ
....(.
!'....S`..F...3..BP.n..j...`Q{..V..v...Z'yT;.j...]..Q+.U.d.Pm.,6..aj..j_....=..T...
goB. .U....s7.......#
)...
</code></pre>

<p>不过payload是binary的，没法直接看出里面是些什么东西。</p>
</div>
  
  
  
    <footer>
        <a href="/blog/2010/03/19/Grab-Android-system-on-network-communication/#disqus_thread">Comments</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/03/11/Study-of-the-issue-that-CXF-can-t-run-on-GlassFish/">Study of the Issue That CXF Can&#8217;t Run on GlassFish</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-03-11T11:59:00+08:00" pubdate data-updated="true">2010-03-11</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/softwaredev/'>SoftwareDev</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h2 id="issue">Issue</h2>

<p>SOAP WS client which uses CXF can’t run on GlassFish AS. Getting ClassCastException on invoking some CXF API. The problem was described as CXF-2237 [2].</p>

<h2 id="analysis">Analysis</h2>

<p>JAX-WS is the Java API for XML Web Service defined by JSR 224. SUN provides a JAX-WS reference implementation in Metro project, which is inside GlassFish AS. The SUN JAX-WS implement was later also merged into JDK 6. Apache CXF is another JAX-WS implementation.</p>

<p>An application can select different JAX-WS implementation by Provider SPI. JSR 224 [4] chapter 6.2.1 defines the algorithm of Provider implementation selection:</p>

<blockquote>
  <ol>
    <li>
      <p>If a resource with the name of META-INF/services/javax.xml.ws.spi.Provider exists, then its first line, if present, is used as the UTF-8 encoded name of the implementation class.</p>
    </li>
    <li>
      <p>If the ${java.home}/lib/jaxws.properties file exists and it is readable by the java.util.Properties.load(InputStream) method and it contains an entry whose key is javax.xml.ws.spi.Provider, then the value of that entry is used as the name of the implementation class.</p>
    </li>
    <li>
      <p>If a system property with the name javax.xml.ws.spi.Provider is defined, then its value is used as the name of the implementation class.</p>
    </li>
    <li>
      <p>Finally, a default implementation class name is used.</p>
    </li>
  </ol>
</blockquote>

<p>The Provider implementation class in JDK 6 is <code>com.sun.xml.internal.ws.spi.ProviderImpl</code> in rt.jar. I guess it’s the default implementation as mentioned in step 4.</p>

<p>CXF packages META-INF/services/javax.xml.ws.spi.Provider which points to <code>org.apache.cxf.jaxws.spi.ProviderImpl</code> in cxf.jar. It will be considered in step 1.</p>

<p>Metro also packages META-INF/services/javax.xml.ws.spi.Provider which points to <code>com.sun.xml.ws.spi.ProviderImpl</code> in webservices-rt.jar. It also will be considered in step 1.</p>

<p>Because in GlassFish the Metro library is in system classpath, so its META-INF/services/javax.xml.ws.spi.Provider will be loaded precede over CXF’s. That’s why Metro will always be used as JAX-WS implement no matter CXF exists or not.</p>

<h2 id="potential-solution">Potential Solution</h2>

<h3 id="classloader-control">Classloader control</h3>

<p>If we can force the JVM to load resource from cxf.jar prior to webservices-rt.jar that will be fine. But GlassFish hasn’t the mechanism likeWebLogic’s <code>&lt;prefer-application-packages&gt;</code>[5]. After some finding we give up this approach.</p>

<h3 id="remove-metro-from-glassfish">Remove Metro from GlassFish</h3>

<p>If there is no application which deploys on the this application server that depends on Metro, we can remove Metro lib (webservices-*.jar) from GlassFish’s lib folder.</p>

<h3 id="change-to-metro">Change to Metro</h3>

<p>That’s nothing to say. We finally choose this way. There is almost no workload to migrate our code from CXF to Metro, because both of them follows JAX-WS specification, except that some code that calls CXF specify API need to be changed. We even don’t change the build script and still use CXF’s wsdl2java tool.</p>

<h2 id="reference">Reference</h2>

<ol>
  <li><a href="https://issues.apache.org/jira/browse/CXF-857">CXF Issue: CXF-857</a></li>
  <li><a href="https://issues.apache.org/jira/browse/CXF-2237">CXF Issue: CXF-2237</a></li>
  <li><a href="http://stackoverflow.com/questions/2064068/how-to-pick-cxf-over-metro-on-glassfish">StackOverflow: How to pick CXF over Metro on Glassfish</a></li>
  <li><a href="http://jcp.org/en/jsr/detail?id=224">JSR 224: JAX-WS 2.x</a></li>
  <li><a href="http://good-good-study.appspot.com/blog/posts/4218">WebLogic的classloading</a></li>
</ol>
</div>
  
  
  
    <footer>
        <a href="/blog/2010/03/11/Study-of-the-issue-that-CXF-can-t-run-on-GlassFish/#disqus_thread">Comments</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/27/Portable-pedestrians-cross-the-street-warning-great/">便携式行人过街警示棒</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-27T01:40:00+08:00" pubdate data-updated="true">2010-02-27</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/idea/'>Idea</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="http://farm5.static.flickr.com/4010/4390272360_cd4c3c040a_o.jpg" alt="" /></p>

<p>几乎每次过马路，我都恨不得手里有这样一块牌子，可以伸到身体前面，把来车挡住 —- 在没有交通灯的斑马线，十个司机有九个会毫不减速的冲过，而不会避让过马路的行人；即使在有交通灯的斑马线，如果不是路口，也有司机根本当红灯不存在。</p>

<p>我想，能不能做个可伸缩的棒，例如是套筒的方式，里面加上弹簧，缩起来的时候大概烟盒大小，可以方便的放在口袋，当需要过马路的时候，将它弹出来，变成一米左右的长度。棒身用红、黄鲜艳颜色的反光材料覆盖。为了增大可视面积，棒伸展时需要在前端弹出一个平面，应该用个弹性钢丝圈加上薄膜可以做出来，类似可折叠太阳帽的样子。过完马路后一压就能够把警示棒收起来。</p>

<p>Beatles四位大叔过Abbey Road时就是这样子的：</p>

<p><img src="http://farm5.static.flickr.com/4003/4390322224_a0a6979623_o.jpg" alt="" /></p>

<p>现在激光全息成像技术还不成熟，如果能够做到便携化，还可以从口袋里掏出激光器一照，一个栅栏就出来了：</p>

<p><img src="http://farm3.static.flickr.com/2711/4389554227_f36eafa67f_o.jpg" alt="" /></p>

<p>至于驾车人士关心的如何制止行人乱穿马路，那就是不是我考虑的问题了。我自己是遵守交通规则的，有斑马线就走斑马线，有行人交通灯就等绿灯才过。</p>

<p>欢迎驾车人士批判，哈哈 :)</p>
</div>
  
  
  
    <footer>
        <a href="/blog/2010/02/27/Portable-pedestrians-cross-the-street-warning-great/#disqus_thread">Comments</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/26/Two-questions-about-SIP-message-transport/">Two Questions About SIP Message Transport</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-02-26T12:30:00+08:00" pubdate data-updated="true">2010-02-26</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/sip/'>SIP</a>, <a class='tag' href='/blog/tags/softwaredev/'>SoftwareDev</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><h3 id="sip-messages-are-sent-in-mix-of-udp-and-tcp">SIP messages are sent in mix of UDP and TCP</h3>

<p>In our test we found that our client first sent SIP messages in UDP but later on it changed to TCP. Is it an issue?</p>

<p>In RFC 3261 (SIP) chapter 18.1.1 and 18.2.1, it says:</p>

<blockquote>
  <p>If a request is within 200 bytes of the path MTU, or if it is larger than 1300 bytes and the path MTU is unknown, the request MUST be sent using an RFC 2914 congestion controlled transport protocol, such as TCP. … This prevents fragmentation of messages over UDP and provides congestion control for larger messages.</p>

  <p>For any port and interface that a server listens on for UDP, it MUST listen on that same port and interface for TCP. This is because a message may need to be sent using TCP, rather than UDP, if it is too large.</p>
</blockquote>

<p>So, whether send a SIP message in UDP or TCP is decided bytransport layer. When the initial SIP message of a transaction is sent in UDP it’s possible that the consequent messages are sent in TCP.</p>

<h3 id="sip-message-is-resent-in-05-second">SIP MESSAGE is resent in 0.5 second</h3>

<p>In another test case we found that the client resends the SIP MESSAGE request in 0.5 second if it doesn’t receive the response. We know that SIP message should be resent in a specific time if no response is received. But why the interval is 0.5 second? Is it configurable in Sailfin?</p>

<p>Also go to RFC 3261, find the answer in chapter 17.1.1.2 and 17.1.2.2:</p>

<blockquote>
  <p>If an unreliable transport is in use, the client transaction MUST set timer E to fire in T1 seconds. If timer E fires while still in this state, the timer is reset, but this time with a value of MIN(2<em>T1, T2). When the timer fires again, it is reset to a MIN(4</em>T1, T2). … For the default values of T1 and T2, this results in intervals of 500 ms, 1 s, 2 s, 4 s, 4 s, 4 s, etc.</p>

  <p>The default value for T1 is 500 ms. T1 is an estimate of the RTT between the client and server transactions. … T1 MAY be chosen larger, and this is RECOMMENDED if it is known in advance (such as on high latency access links) that the RTT is larger.</p>
</blockquote>

<p>In SailFin(GlassFish) the value of T1 and T2 can be configured in admin console under: Configuration - SIP Service - SIP Protocol.</p>
</div>
  
  
  
    <footer>
        <a href="/blog/2010/02/26/Two-questions-about-SIP-message-transport/#disqus_thread">Comments</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2010/02/24/Illustration-Spring-ApplicationContext-in-enterprise-application/">图解：Spring ApplicationContext in Enterprise Application</a></h1>
    
    
      <p class="meta">
        








  



  
<time datetime="2010-02-24T21:46:00+08:00" pubdate data-updated="true">2010-02-24</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/softwaredev/'>SoftwareDev</a>, <a class='tag' href='/blog/tags/springframework/'>SpringFramework</a>
  
</span>


        
      </p>
    
  </header>


  <div class="entry-content"><p>在一个比较复杂的enterprise application (EAR)里面，往往有多个war和ejb，如果希望使用Springframework通过IoC方式来管理及装配POJO beans，就要面对如何初始化application context，由谁来初始化，如何让这些war和ejb共享application context等问题。</p>

<p>关于多个war、ejb共享application context的方法，在下面这两篇文章里解释得比较清楚：</p>

<ul>
  <li><a href="http://blog.springsource.com/2007/06/11/using-a-shared-parent-application-context-in-a-multi-war-spring-application/">Using a shared parent application context in a multi-war Spring application</a></li>
  <li><a href="http://springtips.blogspot.com/2007/09/using-shared-context-from-ejbs.html">Using a Shared Context from EJBs</a></li>
</ul>

<p>在这里，我不再详细叙述上面文章中的内容，通过图解的方式希望能让它更易理解，需要对照阅读。</p>

<p>图中的方块、圆圈都表示实例，形状的嵌套表示它们的包含关系。在例子里，缺省值都显式写出来，方便查找。</p>

<p><a href="http://www.flickr.com/photos/leoliang/4384915548/"><img src="http://farm5.static.flickr.com/4037/4384915548_2ec7d610e6_o.png" alt="share-context-1" /></a></p>

<p>先看图中靛蓝色的box，是ContextSingletonBeanFactoryLocator实例，application context的共享是依靠它来实现的：对于每个locatorFactorSelector，在一个classloader的范围内只会存在一个ContextSingletonBeanFactoryLocator的实例。ContextSingletonBeanFactoryLocator内部有一个ApplicationContext（图中的天蓝色box），它的bean是由locatorFactorSelector所指向的xml文件所定义的。例如locatorFactorSelector为classpath*:beanRefContext.xml，就会寻找classpath中所有的beanRefContext.xml文件并根据它们去创建内部ApplicationContext。这个内部ApplicationContext只是其它ApplicationContext的容器，不存放application的bean。一个beanRefContext.xml文件应该像下面那样，里面是一个ApplicationContext，它才是真正的业务bean的容器。如果需要可以设置它的parent context。如果有多个beanRefContext.xml文件，就会创建多个ApplicationContext，它们通过id来标识。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>beanRefContext.xml
</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line"><span class="nt">&lt;beans&gt;</span>
</span><span class="line">    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">&quot;a&quot;</span> <span class="na">class=</span><span class="s">&quot;org.springframework.context.support.ClassPathXmlApplicationContext&quot;</span><span class="nt">&gt;</span>
</span><span class="line">        <span class="nt">&lt;constructor-arg&gt;</span>
</span><span class="line">            <span class="nt">&lt;list&gt;</span>
</span><span class="line">                <span class="nt">&lt;value&gt;</span>context_a.xml<span class="nt">&lt;/value&gt;</span>
</span><span class="line">            <span class="nt">&lt;/list&gt;</span>
</span><span class="line">        <span class="nt">&lt;/constructor-arg&gt;</span>
</span><span class="line">        <span class="nt">&lt;constructor-arg&gt;</span>
</span><span class="line">            <span class="nt">&lt;ref</span> <span class="na">bean=</span><span class="s">&quot;b&quot;</span> <span class="nt">/&gt;</span>
</span><span class="line">        <span class="nt">&lt;/constructor-arg&gt;</span>
</span><span class="line">    <span class="nt">&lt;/bean&gt;</span>
</span><span class="line"><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>EJB应该在onCreate()过程中通过下面的代码来获得application context，需要通过factoryKey（例子里是”a”）来指定具体是哪个context：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">beanFactory</span><span class="o">=</span> <span class="n">ContextSingletonBeanFactoryLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;classpath*:beanRefContext.xml&quot;</span><span class="o">).</span><span class="na">useBeanFactory</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">).</span><span class="na">getFactory</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>在war里是依靠ContextLoaderListener来启动ApplicationContext的。在web.xml里加入：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>web.xml    
</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line">    <span class="nt">&lt;listener&gt;</span>
</span><span class="line">        <span class="nt">&lt;listener-class&gt;</span>
</span><span class="line">            org.springframework.web.context.ContextLoaderListener
</span><span class="line">        <span class="nt">&lt;/listener-class&gt;</span>
</span><span class="line">    <span class="nt">&lt;/listener&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这个application context包含的是/WEB-INF/applicationContext.xml中定义的beans。在Servlet中通过下面的代码可以获得这个context：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">beanFactory</span> <span class="o">=</span> <span class="n">WebApplicationContextUtils</span><span class="o">.</span><span class="na">getWebApplicationContext</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">());</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>但这样创建出来的是一个独立的application context，仅仅在war内部可以访问，无法做到多个war和ejb之间共享。</p>

<p>要实现共享，就要在web.xml中再加入：</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>web.xml
</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="xml"><span class="line">    <span class="nt">&lt;context-param&gt;</span>
</span><span class="line">        <span class="nt">&lt;param-name&gt;</span>parentContextKey<span class="nt">&lt;/param-name&gt;</span>
</span><span class="line">        <span class="nt">&lt;param-value&gt;</span>b<span class="nt">&lt;/param-value&gt;</span>
</span><span class="line">    <span class="nt">&lt;/context-param&gt;</span>
</span><span class="line">    <span class="nt">&lt;context-param&gt;</span>
</span><span class="line">        <span class="nt">&lt;param-name&gt;</span>locatorFactorySelector<span class="nt">&lt;/param-name&gt;</span>
</span><span class="line">        <span class="nt">&lt;param-value&gt;</span>classpath*:beanRefContext.xml<span class="nt">&lt;/param-value&gt;</span> <span class="c">&lt;!-- this is the default value --&gt;</span>
</span><span class="line">    <span class="nt">&lt;/context-param&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>这样，当ContextLoaderListener创建war的application context时，会根据locatorFactorySelector去取相应的ContextSingletonBeanFactoryLocator实例，并且从locator中根据parentContextKey拿到具体的context，将这个context作为war的application context的parent。在图中，war 1的servlet可以访问到key为’b’的context，因为它是当前context的parent。</p>

<p>最后的效果就是：哪个war或者ejb先初始化，它就会去初始化ContextSingletonBeanFactoryLocator实例，由于是singleton，只会有一个实例存在，所有的war和ejb都从这个locator里面拿到具体存放业务bean的context，实现了context的共享。</p>

<p>在这里需要留意的是classloader，必须很清楚的知道哪些类是由哪个层次的classloader加载的：所有共享的bean，以及相关的spring jar都必须由EJB classloader加载。关于EAR的classloader及层次关系请参看 <a href="http://good-good-study.appspot.com/blog/posts/4218">WebLogic的classloading</a>。</p>

<p>在实际应用中，往往不需要对application context作隔离，整个ear里面所有ejb、war共享一个application context是最简便的。这时war里不需要定义任何context和context loader，与EJB一样直接使用ContextSingletonBeanFactoryLocator就可以获取到context。</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">beanFactory</span><span class="o">=</span> <span class="n">ContextSingletonBeanFactoryLocator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">&quot;classpath*:beanRefContext.xml&quot;</span><span class="o">).</span><span class="na">useBeanFactory</span><span class="o">(</span><span class="s">&quot;share-context&quot;</span><span class="o">).</span><span class="na">getFactory</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><a href="http://www.flickr.com/photos/leoliang/5370082919/"><img src="http://farm6.static.flickr.com/5245/5370082919_6dfc7f7b1d_z.jpg" alt="sping_shared_context" /></a></p>
</div>
  
  
  
    <footer>
        <a href="/blog/2010/02/24/Illustration-Spring-ApplicationContext-in-enterprise-application/#disqus_thread">Comments</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/13/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/blog/page/11/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Note</h1>
  <p>中国大陆用户可能会因为网络被屏蔽而无法访问本网站或部分内容(文字/图片), 如遇到这种情况, 请翻墙访问</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/09/09/running-route-luhu/">广州跑步路线: 麓湖</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/09/running-route/">广州跑步路线：索引</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/08/10/understanding-weblogic-workmanager/">Understanding WebLogic WorkManager</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/31/apigee/">apigee</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/07/22/xperia-u/">Xperia U 上手</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
<a style="font-size: 135%" href="/blog/tags/android/">Android</a>
<a style="font-size: 114%" href="/blog/tags/anti-gfw/">Anti-GFW</a>
<a style="font-size: 93%" href="/blog/tags/appserver/">AppServer</a>
<a style="font-size: 99%" href="/blog/tags/architecture/">Architecture</a>
<a style="font-size: 70%" href="/blog/tags/artculture/">ArtCulture</a>
<a style="font-size: 116%" href="/blog/tags/blogging/">Blogging</a>
<a style="font-size: 114%" href="/blog/tags/civilsociety/">CivilSociety</a>
<a style="font-size: 108%" href="/blog/tags/diy/">DIY</a>
<a style="font-size: 70%" href="/blog/tags/database/">Database</a>
<a style="font-size: 70%" href="/blog/tags/design/">Design</a>
<a style="font-size: 70%" href="/blog/tags/environmentalprotection/">EnvironmentalProtection</a>
<a style="font-size: 70%" href="/blog/tags/excel/">Excel</a>
<a style="font-size: 99%" href="/blog/tags/funny/">Funny</a>
<a style="font-size: 144%" href="/blog/tags/gps-gis/">GPS_GIS</a>
<a style="font-size: 70%" href="/blog/tags/geek/">Geek</a>
<a style="font-size: 70%" href="/blog/tags/geocaching/">Geocaching</a>
<a style="font-size: 70%" href="/blog/tags/homeappliance/">HomeAppliance</a>
<a style="font-size: 140%" href="/blog/tags/idea/">Idea</a>
<a style="font-size: 108%" href="/blog/tags/imageprocessing/">ImageProcessing</a>
<a style="font-size: 85%" href="/blog/tags/java/">Java</a>
<a style="font-size: 70%" href="/blog/tags/learning/">Learning</a>
<a style="font-size: 108%" href="/blog/tags/life/">Life</a>
<a style="font-size: 85%" href="/blog/tags/maven/">Maven</a>
<a style="font-size: 140%" href="/blog/tags/misc/">Misc</a>
<a style="font-size: 108%" href="/blog/tags/mywork/">MyWork</a>
<a style="font-size: 85%" href="/blog/tags/novel/">Novel</a>
<a style="font-size: 85%" href="/blog/tags/outdoor/">Outdoor</a>
<a style="font-size: 104%" href="/blog/tags/personaldevelopment/">PersonalDevelopment</a>
<a style="font-size: 119%" href="/blog/tags/reading/">Reading</a>
<a style="font-size: 116%" href="/blog/tags/running/">Running</a>
<a style="font-size: 70%" href="/blog/tags/sip/">SIP</a>
<a style="font-size: 137%" href="/blog/tags/software/">Software</a>
<a style="font-size: 160%" href="/blog/tags/softwaredev/">SoftwareDev</a>
<a style="font-size: 93%" href="/blog/tags/springframework/">SpringFramework</a>
<a style="font-size: 126%" href="/blog/tags/sysadmin/">SysAdmin</a>
<a style="font-size: 121%" href="/blog/tags/timemanagement/">TimeManagement</a>
<a style="font-size: 85%" href="/blog/tags/ux/">UX</a>
<a style="font-size: 108%" href="/blog/tags/web/">Web</a>
<a style="font-size: 99%" href="/blog/tags/weblogic/">WebLogic</a>
<a style="font-size: 70%" href="/blog/tags/i18n/">i18n</a>

  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Leo Liang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'aleung';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
