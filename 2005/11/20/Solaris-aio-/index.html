
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Solaris上使用aio的问题 - Good good study, day day up</title>
  <meta name="author" content="Leo Liang">

  
  <meta name="description" content="我们程序的IRI backend使用了ACE Proactor作为TCP client的框架，proactor实质上是使用了asynchronous IO(aio)从socket上读写数据。异步IO将速度慢的I/O过程留在操作系统内部进行，不会阻塞用户线程， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://aleung.github.com/blog/2005/11/20/Solaris-aio-/">
  <link href="/blog/favicon.png" rel="icon">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/GoodGoodStudyDayDayUp" rel="alternate" title="Good good study, day day up" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2827715-4']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/blog/">Good good study, day day up</a></h1>
  
    <h2>aleung的学习笔记, aleung的idea</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/GoodGoodStudyDayDayUp" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:aleung.github.com/blog" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/blog/">Blog</a></li>
  <li><a href="/blog/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Solaris上使用aio的问题</h1>
    
    
      <p class="meta">
        








  


<time datetime="2005-11-20T02:17:00+08:00" pubdate data-updated="true">2005-11-20</time>
        
         | 

<span class="tags">
  
    <a class='tag' href='/blog/tags/softwaredev/'>SoftwareDev</a>
  
</span>


        
      </p>
    
  </header>


<div class="entry-content"><p>我们程序的IRI backend使用了ACE Proactor作为TCP client的框架，proactor实质上是使用了asynchronous IO(aio)从socket上读写数据。异步IO将速度慢的I/O过程留在操作系统内部进行，不会阻塞用户线程，因此在应用中无需使用多线程也可以达到较高的效率。AIO在windows平台上使用比较广泛，称为CPIO。Solaris 9是支持aio的，按理说不会有什么问题，可是我们的程序就出现了很多奇怪的问题。</p>

<ul>
  <li>有时CPU占用莫名其妙的很高，即使没有从网络收发数据 </li>
  <li>进程的lwp数量会变化，某些时候不断增加 </li>
  <li>用truss跟踪程序的时候，CPU就会降低</li>
</ul>

<p>反复检查过程序，都没有发现问题，程序只有一个线程进入了proactor，怀疑是ACE的proactor内部创建了线程，但看过ACE代码，里面也没有spawn线程。而且aio就是为了提高用户线程效率，让单线程可以处理大量并发IO的，没有理由需要再创建多线程。</p>

<p>我们的鬼佬chief architect是hacker出身的，他跟我们一起查找问题，最终找到了原因。</p>

<blockquote>
  <p>Some notes for us on AIO to help us better understand:</p>

  <p>[1] <a href="http://sunsite.uakom.sk/sunworldonline/swol-03-1996/swol-03-aio.html">http://sunsite.uakom.sk/sunworldonline/swol-03-1996/swol-03-aio.html</a></p>

  <p>[2] Keep in mind that any major improvement over standard read/write system calls requires the use of multi-processor machines, since AIOs are executed via light weight processes (LWPs). </p>

  <p>[3] aiorandom syiorandom<br />
Both programs read 262,144 data blocks. Each block is 4,096 bytes. aiorandom submits a batch of 30 asynchronous reads at a time. Whenever the number of outstanding AIO operations falls below 15, it submits another batch. Results were recorded from the command timex. </p>

  <table>
    <thead>
      <tr>
        <th> </th>
        <th style="text-align: right"> aiorandom </th>
        <th style="text-align: right">syiorandom</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>real </td>
        <td style="text-align: right">42:43.92 </td>
        <td style="text-align: right">1:02:48.68</td>
      </tr>
      <tr>
        <td>user </td>
        <td style="text-align: right">5:35.57  </td>
        <td style="text-align: right">  4:39.38</td>
      </tr>
      <tr>
        <td>sys </td>
        <td style="text-align: right">5:24.02  </td>
        <td style="text-align: right">  2:41.23</td>
      </tr>
    </tbody>
  </table>

  <p>For aiorandom, this is a speed-up of close to 30 percent in real (elapsed) time. Note how aiorandom consumed more user CPU time due to the extra work associated with managing the AIO-related data structures. System CPU time doubled thanks to aiorandom running multiple LWPs. Keep this in mind on busy, multi-user systems since heavy AIO applications will depress the performance of other apps. </p>

  <p>[4]  However, libaio is different; it implements system functions. Depending on the numbers of submitted AIO requests, libaio creates so-called “workers” (as implemented as LWP’s) to process the IO requests. </p>

  <p>THIS IS WHAT IS KAIO .. [next line]</p>

  <p>[1]  Solaris 2.5 implements kernel-supported asynchronous I/O. The kernel has implemented special, efficient AIO assists for the libaio. </p>

  <p>[2] <a href="http://developers.sun.com/solaris/articles/thread_pools.html">http://developers.sun.com/solaris/articles/thread_pools.html</a></p>

  <p>Here is the code from aio.so:</p>

  <p><a href="http://cvs.opensolaris.org/source/xref/on/usr/src/uts/common/os/aio.c">aio.c</a></p>

  <p>    394 /*<br />
    395  * wake up LWPs in this process that are sleeping in<br />
    396  * aiowait().<br />
    397  <em>/<br />
    398 static int<br />
    399 aionotify(void)<br />
    400 {<br />
    401  aio_t </em>aiop;<br />
    402 <br />
    403  aiop = curproc-&gt;p_aio;<br />
    404  if (aiop == NULL)<br />
    405   return (0);<br />
    406 <br />
    407  mutex_enter(&amp;aiop-&gt;aio_mutex);<br />
    408  aiop-&gt;aio_notifycnt++;<br />
    409  <strong>cv_broadcast(&amp;aiop-&gt;aio_waitcv);</strong><br />
    410  mutex_exit(&amp;aiop-&gt;aio_mutex);<br />
    411 <br />
    412  return (0);<br />
    413 }</p>

  <p>If the application uses a third party library that implements asynchronous operations, this may not be the best solution. This is because of the “anonymous” nature of aiowait(), which returns the result of any asynchronous read or write operation. And if a third party AIO library is used in the application, this means that aiowait() could return result sets of the third party library AIO calls as well. Due to obvious interface disparities, this could lead to unpredictable behavior. </p>

  <p>.. i find out some very interesting things about the aio … especially<br />
the CPU usage being high is very normal .. good if you want<br />
to make a high capacity/performance server that will run on <br />
its own on a SMP machine .. then aio gives a very strong <br />
efficiency and raw performance .. but use extra CPU because<br />
the process have very high granularity of checking all async <br />
operations .. much higher than a user space thread .. </p>

  <p>however this kind of server will hog CPU and if used in a mixed<br />
environment with many other systems on same host will not be<br />
a good solution .. also such process have no ability to define <br />
filters on the async events they listen for .. they will always get<br />
interrupts from any kind of asynch event in the system . .then <br />
have to go through that array of 1024 pointers and check if any<br />
of the non-null pointers in there will contain an event for them …. <br />
(thats why if you connect truss -p the CPU goes down .. all sigs<br />
are blocked for a process inside truss) </p>

  <p>the behaviour with CPU etc. that we see in ismapserver seems<br />
quite ‘normal’ for the aio .. from what i can read the last days and<br />
from what you can see in the solaris os code. (you can also look <br />
in kernel.c and condvar.c) </p>
</blockquote>

<p>看来aio并不是那么好用，对于我们的程序而言，IRI接口的网络吞吐量并不是瓶颈，而且我们的程序本来就是多线程程序，其实并不需要使用aio。程序中的其他网络接口使用的TP Reactor（基于多线程，select）就工作得很好，效率也远超出需求了。对于IRI backend，甚至用一个线程收一个线程发就够了，因为不需要处理太多connection，线程数量在这里不是问题。</p>

<p>还是应该遵循用最简单的方法来解决问题的原则。</p>
</div>


  <footer>
    <p class="meta">
    <!--
      
  

<span class="byline author vcard">Posted by <span class="fn">Leo Liang</span></span>

      








  


<time datetime="2005-11-20T02:17:00+08:00" pubdate data-updated="true">2005-11-20</time>
      


      

<span class="tags">
  
    <a class='tag' href='/blog/tags/softwaredev/'>SoftwareDev</a>
  
</span>


    -->
    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://aleung.github.com/blog/2005/11/20/Solaris-aio-/" data-via="acette" data-counturl="http://aleung.github.com/blog/2005/11/20/Solaris-aio-/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2005/11/10/Memory-allocator-/" title="Previous Post: Memory allocator影响多线程程序效率">&laquo; Memory allocator影响多线程程序效率</a>
      
      
        <a class="basic-alignment right" href="/blog/2005/11/28/The-network-of-killing-game-formerly-known-as-F2F-face-to-face-/" title="Next Post: 网络上的杀人游戏（原名：F2F—面对面）">网络上的杀人游戏（原名：F2F—面对面） &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Note</h1>
  <p>中国大陆用户可能会因为网络被屏蔽而无法访问本网站或部分内容(文字/图片), 如遇到这种情况, 请翻墙访问</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/30/mi2-usb-debug-on-osx/">怎样在OSX上adb连接小米2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/23/mi2/">四儿子无望，粗粮也好吧</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/12/11/my-first-half-marathon/">我的首個半馬拉松</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/10/06/change-locale-in-android-application/">Android: 在應用中設定locale</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/09/17/Java-volatile-/">Java的volatile关键字的作用</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Tags</h1>
  <ul class="tag-cloud">
<a style="font-size: 138%" href="/blog/tags/android/">Android</a>
<a style="font-size: 114%" href="/blog/tags/anti-gfw/">Anti-GFW</a>
<a style="font-size: 93%" href="/blog/tags/appserver/">AppServer</a>
<a style="font-size: 99%" href="/blog/tags/architecture/">Architecture</a>
<a style="font-size: 70%" href="/blog/tags/artculture/">ArtCulture</a>
<a style="font-size: 116%" href="/blog/tags/blogging/">Blogging</a>
<a style="font-size: 114%" href="/blog/tags/civilsociety/">CivilSociety</a>
<a style="font-size: 108%" href="/blog/tags/diy/">DIY</a>
<a style="font-size: 70%" href="/blog/tags/database/">Database</a>
<a style="font-size: 70%" href="/blog/tags/design/">Design</a>
<a style="font-size: 70%" href="/blog/tags/environmentalprotection/">EnvironmentalProtection</a>
<a style="font-size: 70%" href="/blog/tags/excel/">Excel</a>
<a style="font-size: 99%" href="/blog/tags/funny/">Funny</a>
<a style="font-size: 144%" href="/blog/tags/gps-gis/">GPS_GIS</a>
<a style="font-size: 70%" href="/blog/tags/geek/">Geek</a>
<a style="font-size: 70%" href="/blog/tags/geocaching/">Geocaching</a>
<a style="font-size: 70%" href="/blog/tags/homeappliance/">HomeAppliance</a>
<a style="font-size: 140%" href="/blog/tags/idea/">Idea</a>
<a style="font-size: 111%" href="/blog/tags/imageprocessing/">ImageProcessing</a>
<a style="font-size: 93%" href="/blog/tags/java/">Java</a>
<a style="font-size: 70%" href="/blog/tags/learning/">Learning</a>
<a style="font-size: 108%" href="/blog/tags/life/">Life</a>
<a style="font-size: 85%" href="/blog/tags/maven/">Maven</a>
<a style="font-size: 139%" href="/blog/tags/misc/">Misc</a>
<a style="font-size: 108%" href="/blog/tags/mywork/">MyWork</a>
<a style="font-size: 85%" href="/blog/tags/novel/">Novel</a>
<a style="font-size: 85%" href="/blog/tags/outdoor/">Outdoor</a>
<a style="font-size: 104%" href="/blog/tags/personaldevelopment/">PersonalDevelopment</a>
<a style="font-size: 118%" href="/blog/tags/reading/">Reading</a>
<a style="font-size: 120%" href="/blog/tags/running/">Running</a>
<a style="font-size: 70%" href="/blog/tags/sip/">SIP</a>
<a style="font-size: 137%" href="/blog/tags/software/">Software</a>
<a style="font-size: 160%" href="/blog/tags/softwaredev/">SoftwareDev</a>
<a style="font-size: 93%" href="/blog/tags/springframework/">SpringFramework</a>
<a style="font-size: 126%" href="/blog/tags/sysadmin/">SysAdmin</a>
<a style="font-size: 120%" href="/blog/tags/timemanagement/">TimeManagement</a>
<a style="font-size: 85%" href="/blog/tags/ux/">UX</a>
<a style="font-size: 108%" href="/blog/tags/web/">Web</a>
<a style="font-size: 99%" href="/blog/tags/weblogic/">WebLogic</a>
<a style="font-size: 70%" href="/blog/tags/i18n/">i18n</a>

  </ul>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Leo Liang -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'aleung';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://aleung.github.com/blog/2005/11/20/Solaris-aio-/';
        var disqus_url = 'http://aleung.github.com/blog/2005/11/20/Solaris-aio-/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
